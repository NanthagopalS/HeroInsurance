      /*          
   exec [dbo].[Insurance_SaveQuoteTransaction] @InsurerId=N'0A326B77-AFD5-44DA-9871-1742624CFF16',@ResponseBody=N'{"StatusCode":404,"Message":null,"Error":"Please provide RTO Location Code","Warning":null,"GC_PolicyNo":null,"Authentication":null,"Customer
  
    
      
        
_Details":null,"Policy_Details":null,"Payment_Details":null,"Resp_GCV":null,"Resp_MISD":null,"Resp_PCV":null,"CalculatedIDV":null,"TransactionID":"HEROPC20230705114626","Resp_ExtendedWarranty":null,"Resp_Policy_Document":null,"Resp_TW":null,"Resp_RE":null
  
    
      
        
,"Resp_ClaimIntimation":null,"Resp_ClaimStatus":null,"Resp_Fire2111":null,"Resp_PvtCar":null,"Resp_IPA":null,"Resp_HSTPI":null,"Resp_HSTPF":null,"Resp_Discount":null,"Resp_POSP":null,"Res_NSTPDecision":null,"Res_GetStatus":null,"Resp_UploadDocument":null,
  
    
      
        
"Resp_PolicyDetails":null,"Res_PolicyStatus":null,"Res_MasterData":null,"Res_appstatus":null,"Resp_CBDetails":null,"Resp_OptimaRestore":null,"Resp_AMIPA":null,"Resp_Ican":null,"Resp_ECB_ClaimStatus":null,"Resp_OptimaSuper":null,"Resp_CDBalance":null,"Resp
  
    
      
        
_HSI":null,"Resp_HF":null,"Resp_HW":null,"PaymentStatusDetails":null,"Resp_PospStatus":null,"Resp_energy":null,"Response_Data_OS":null,"Res_ProposalStatus":null,"Resp_GHCIP":null,"Resp_CyberSachet":null,"Response_MarineOpen":null}',@RequestBody=N'{"Applic
  
    
      
        
ationNumber":null,"TransactionID":"HEROPC20230705114626","GoGreen":false,"IsReadyToWait":null,"PolicyCertifcateNo":null,"PolicyNo":null,"Proposal_no":null,"Inward_no":null,"Request_IP":null,"Customer_Details":null,"Policy_Details":{"PolicyStartDate":"05/0
  
    
      
        
7/2023","ProposalDate":"05/07/2023","PolicyEndDate":"04/07/2024","AgreementType":"","FinancierCode":null,"BranchName":null,"PreviousPolicy_CorporateCustomerId_Mandatary":"","PreviousPolicy_NCBPercentage":0,"PreviousPolicy_PolicyEndDate":null,"PreviousPoli
  
    
      
        
cy_PolicyStartDate":null,"PreviousPolicy_PolicyNo":null,"PreviousPolicy_PolicyClaim":null,"PreviousPolicy_PreviousPolicyType":null,"PreviousPolicy_TPENDDATE":null,"PreviousPolicy_TPSTARTDATE":null,"PreviousPolicy_TPINSURER":null,"PreviousPolicy_TPPOLICYNO
  
    
      
        
":null,"PreviousPolicy_IsZeroDept_Cover":true,"PreviousPolicy_IsRTI_Cover":true,"BusinessType_Mandatary":"New           
Vehicle","VehicleModelCode":"12815","DateofDeliveryOrRegistration":"03/07/2023","DateofFirstRegistration":"03/07/2023","YearOfManufacture":"2023","Registration_No":null,"EngineNumber":null,"ChassisNumber":null,"RTOLocationCode":null,"Vehicle_IDV":0.0,"End
  
    
      
        
orsementEffectiveDate":null,"SumInsured":0,"Premium":0.0,"EXEMPTED_KERALA_FLOOD_CESS":null,"CUSTOMER_STATE_CD":null,"TXT_GIR_NO":null,"TSECode":null,"AVCode":null,"SMCode":null,"LGCode":null,"BankLocation":null,"ChannelName":null,"SPCode":null,"BANK_BRANC
  
    
      
        
H_ID":null,"AV_SP_Code":null,"PB_Code":null,"Lead_ID":null,"AutoRenewal":null,"Type_of_payment":null,"PolicyType":null,"FamilyType":null,"TypeofPlan":null,"PolicyTenure":0,"Deductible":0.0},"Req_GCV":null,"Req_MISD":null,"Req_PCV":null,"Payment_Details":n
  
    
      
        
ull,"IDV_DETAILS":null,"Req_ExtendedWarranty":null,"Req_Policy_Document":null,"Req_PEE":null,"Req_TW":null,"Req_RE":null,"Req_Fire2111":null,"Req_ClaimIntimation":null,"Req_ClaimStatus":null,"Req_Renewal":null,"Req_PvtCar":{"POSP_CODE":"","POLICY_TYPE":"O
  
    
      
        
D           
Plus           
TP","POLICY_TENURE":3,"ExtensionCountryCode":0.0,"ExtensionCountryName":null,"BreakIN_ID":"","BreakInStatus":"","BreakInInspectionFlag":"","BreakinWaiver":false,"BreakinInspectionDate":null,"Effectivedrivinglicense":false,"NumberOfEmployees":0,"BiFuelType
  
    
      
        
":null,"BiFuel_Kit_Value":0.0,"LLPaiddriver":0,"PAPaiddriverSI":0.0,"Owner_Driver_Nominee_Name":"","Owner_Driver_Nominee_Age":0,"Owner_Driver_Nominee_Relationship":"","Owner_Driver_Appointee_Name":"","Owner_Driver_Appointee_Relationship":"","IsZeroDept_Co
  
          
        
ver":0,"IsTyreSecure_Cover":0,"ElecticalAccessoryIDV":0.0,"NonElecticalAccessoryIDV":0.0,"OtherLoadDiscRate":0.0,"AntiTheftDiscFlag":false,"HandicapDiscFlag":false,"IsNCBProtection_Cover":0,"IsRTI_Cover":0,"IsCOC_Cover":0,"IsEngGearBox_Cover":0,"IsLossofU
  
    
      
        
seDownTimeProt_Cover":0,"IsEA_Cover":0,"IsEAW_Cover":0,"IsEAAdvance_Cover":0,"IsTowing_Cover":0,"Towing_Limit":"","IsEMIProtector_Cover":0,"NoOfEmi":"","EMIAmount":0.0,"NoofUnnamedPerson":0,"UnnamedPersonSI":0.0,"Voluntary_Excess_Discount":0.0,"IsLimitedt
  
    
      
        
oOwnPremises":0,"TPPDLimit":0.0,"NoofnamedPerson":0,"namedPersonSI":0.0,"NamedPersons":"","AutoMobile_Assoication_No":"","fuel_type":"PETROL","CPA_Tenure":3,"PayAsYouDrive":false,"InitialOdometerReading":0,"InitialOdometerReadingDate":null},"Req_HInsuranc
  
    
      
        
e":null,"Req_IPA":null,"Req_CI":null,"Req_HomeInsurance":null,"Req_RetailTravel":null,"Req_HCA":null,"Req_HF":null,"Req_HI":null,"Req_HSTPI":null,"Req_HSTPF":null,"Req_ST":null,"Req_WC":null,"Req_BSC":null,"Req_Discount":null,"Req_POSP":null,"Req_HSF":nul
  
    
      
        
l,"Req_HSI":null,"Req_CustDec":null,"Req_TW_Multiyear":null,"Req_OptimaRestore":null,"Req_Aviation":null,"Req_NE":null,"Req_TravelXDFD":null,"Req_OptimaSenior":null,"Req_Energy":null,"Req_HW":null,"Req_EH":null,"Req_Ican":null,"Req_GetStatus":null,"Reques
  
    
      
        
t_UploadDocument":null,"Req_PolicyDetails":null,"Req_AMIPA":null,"Req_PolicyStatus":null,"Req_MasterData":null,"Req_ChequeDetails":null,"Req_appstatus":null,"Req_OptimaSuper":null,"PaymentStatusDetails":null,"Req_PospCodeStatus":null,"Req_TvlSportify":nul
  
    
      
        
l,"Request_Data_OS":null,"Req_GHCIP":null,"Req_PolicyConfirmation":null,"Req_MarineOpen":null}',@CommonResponse=N'{"InsurerName":"HDFC","InsurerId":null,"InsurerStatusCode":400,"InsurerLogo":null,"CachlessGarageCount":0,"SelfVideoClaim":null,"InsurerDescr
  
    
      
        
iption":null,"TotalPremium":null,"GrossPremium":null,"SelectedIDV":0,"IDV":null,"MinIDV":null,"MaxIDV":null,"NCB":null,"IsRecommended":false,"RecommendedDescription":null,"PolicyStartDate":null,"Tenure":null,"BasicCover":null,"PACovers":null,"AddonCover":
  
    
      
        
null,"Discount":null,"Tax":null,"AccessoriesCover":null,"CashlessGarageList":null,"PremiumBasicDetailsList":null,"TransactionID":null,"RTOCode":null,"PlanType":null,"IsSATPDateMandatory":false,"IsSAODDateMandatory":false,"RegistrationDate":null,"Manufactu
  
    
      
        
ringDate":null,"VehicleNumber":null,"ApplicationId":null,"ProposalNumber":null,"PaymentURLLink":null,"IsBreakIn":false,"IsSelfInspection":false,"isQuoteDeviation":false,"isApprovalRequired":false,"PaymentStatus":null,"PaymentTransactionNumber":null,"BankN
  
    
      
        
ame":null,"BankPaymentRefNum":null,"PaymentMode":null,"PaymentDate":null,"CKYCStatus":null,"Type":null,"CKYCLink":null,"CKYCFailReason":null,"PolicyDocumentLink":null,"DocumentId":null,"PolicyNumber":null,"CustomerId":null,"ValidationMessage":null,"Breaki
  
    
      
        
nStatus":null,"InspectionId":null,"IsTP":false,"BreakinId":null,"IsHtml":false,"QuoteId":null,"ProposalId":null,"PolicyId":null,"BreakinInspectionURL":null}',@Stage=N'Quote',@LeadId=N'HERO/ENQ/107969',@MaxIDV=0,@MinIDV=0,@RecommendedIDV=0,@TransactionId=N
  
    
      
        
ULL,@PolicyNumber=N'',@PolicyId=NULL,@QuoteTransactionId=NULL,@CreatedBy=N'8E5CFA10-4CAA-4100-92AD-9A0E9B3ACC4F',@SelectedIDV=N'0',@PolicyTypeId=N'517D8F9C-F532-4D45-8034-ABECE46693E3',@IsPreviousPolicy=0,@SAODInsurerId=NULL,@SATPInsurerId=NULL,@SAODPolic
  
    
      
        
yStartDate=N'0001-01-01',@SAODPolicyExpiryDate=N'0001-01-01',@SATPPolicyStartDate=N'0001-01-01',@SATPPolicyExpiryDate=N'0001-01-01',@IsPreviousYearClaim=0,@PreviousYearNCB=NULL,@IsBrandNew=1          
   */          
-- Modified By      : Parth Gandhi      
-- Modified Date    : 07,Sept-2023      
-- Modified Purpose : User Story 4126 (Generic IC Wise Key Highlights) Added Column in Insurer Table      
CREATE   PROCEDURE [dbo].[Insurance_SaveQuoteTransaction]                
@InsurerId VARCHAR(50) = NULL,                
@ResponseBody VARCHAR(max) = NULL,                 
@RequestBody VARCHAR(max) = NULL,                 
@CommonResponse VARCHAR(max) = NULL,          
@Stage varchar(20) = null,          
@LeadId NVARCHAR(50) = null,          
@MaxIDV decimal(18,2) = null,          
@MinIDV decimal(18,2) = null,          
@RecommendedIDV decimal(18,2) = null,        
@TransactionId VARCHAR(100) = NULL,          
@PolicyNumber VARCHAR(100) = NULL,          
@PolicyId VARCHAR(100) = NULL,          
@QuoteTransactionId VARCHAR(50)=NULL,          
@CreatedBy VARCHAR(50)=NULL,          
@SelectedIDV VARCHAR(50)=NULL,          
@PolicyTypeId VARCHAR(50)=NULL,          
@IsPreviousPolicy BIT = NULL,          
@SAODInsurerId VARCHAR(50)=NULL,          
@SATPInsurerId VARCHAR(50)=NULL,          
@SAODPolicyStartDate VARCHAR(50)=NULL,          
@SAODPolicyExpiryDate VARCHAR(50)=NULL,          
@SATPPolicyStartDate VARCHAR(50)=NULL,          
@SATPPolicyExpiryDate VARCHAR(50)=NULL,          
@IsPreviousYearClaim BIT = NULL,          
@PreviousYearNCB VARCHAR(50)=NULL,          
@IsBrandNew BIT = NULL,          
@VehicleNumber VARCHAR(20) = NULL,          
@RegistrationDate VARCHAR(20) = NULL,          
@IsSharePaymentLink BIT = NULL,  
@VehicleTypeId VARCHAR(50) = NULL,
@TotalPremium VARCHAR(50) = NULL,
@GrossPremiume VARCHAR(50) = NULL,
@Tax NVARCHAR(MAX) = NULL,
@RTOId VARCHAR(50) = NULL
AS                
BEGIN                
 BEGIN TRY                
            
  DECLARE @QuoteTranID VARCHAR(50) = null, @StageID VARCHAR(50) = (SELECT stageid FROM Insurance_StageMaster WITH(NOLOCK) WHERE stage= @Stage) ;            
  SET @QuoteTranID = NEWID()           
            
  IF @IsSharePaymentLink = 1          
  BEGIN          
   SET @StageID = 'CD0D06FB-3AFC-4AF2-9FE6-3DBF98F0A105'          
  END          
          
  DELETE FROM Insurance_QuoteTransaction WHERE LeadId = @LeadId AND StageID = @StageID AND InsurerId = @InsurerId          
             
  INSERT INTO dbo.Insurance_QuoteTransaction                
  (QuoteTransactionId, InsurerId,ResponseBody,RequestBody,CommonResponse,CreatedBy,          
  StageID,LeadId,MaxIDV,MinIDV,RecommendedIDV,TransactionId,RefQuoteTransactionId,SelectedIDV,     
  ProposalId,PolicyId,RTOId,VehicleNumber)          
  VALUES (@QuoteTranID,@InsurerId,@ResponseBody,@RequestBody,@CommonResponse,@CreatedBy,@StageID,           
  @LeadId,@MaxIDV,@MinIDV,@RecommendedIDV, @TransactionId,@QuoteTransactionId,@SelectedIDV,        
  @PolicyNumber,@PolicyId,@RTOId,@VehicleNumber)           
          
           
  IF(@Stage='Quote')          
  BEGIN          
   IF(@IsBrandNew=1)          
   BEGIN          
    UPDATE Insurance_LeadDetails SET StageId = @StageID,PolicyTypeId = @PolicyTypeId,IsBrandNew = @IsBrandNew,          
    VehicleNumber = @VehicleNumber, RegistrationDate = @RegistrationDate, MakeMonthYear=@RegistrationDate,          
    SelectedIDV = @SelectedIDV          
    WHERE LeadId = @LeadId          
   END          
   ELSE          
   BEGIN          
    UPDATE Insurance_LeadDetails SET StageId = @StageID,PolicyTypeId = @PolicyTypeId,IsBrandNew = @IsBrandNew,          
    IsPrevPolicy = @IsPreviousPolicy, PreviousSAODInsurer = @SAODInsurerId, PreviousSATPInsurer = @SATPInsurerId,          
    PreviousSAODPolicyStartDate = @SAODPolicyStartDate, PreviousPolicyExpirySAOD = @SAODPolicyExpiryDate,          
    PreviousSATPPolicyStartDate = @SATPPolicyStartDate, PrevPolicyExpiryDate = @SATPPolicyExpiryDate,          
    PrevPolicyClaims = CASE WHEN @IsPreviousYearClaim=1 THEN 'YES' ELSE 'NO' END,          
    PrevPolicyNCB = @PreviousYearNCB, VehicleNumber = @VehicleNumber, RegistrationDate = @RegistrationDate          
    ,MakeMonthYear=@RegistrationDate,SelectedIDV = @SelectedIDV          
    WHERE LeadId = @LeadId          
   END          
  END          
  ELSE          
  BEGIN          
    IF @IsSharePaymentLink = 1          
    BEGIN          
     UPDATE Insurance_LeadDetails SET StageId = @StageID, QuoteTransactionID = @QuoteTransactionId,PolicyNumber = @PolicyNumber           
     WHERE LeadId = @LeadId          
    END          
    ELSE   
    BEGIN          
        
     UPDATE Insurance_LeadDetails SET QuoteTransactionID = @QuoteTranID, StageId = @StageID, PolicyNumber = @PolicyNumber           
     WHERE LeadId = @LeadId     
	 IF(@InsurerId = '85F8472D-8255-4E80-B34A-61DB8678135C')
	 BEGIN
		--Need to update these details as we are hitting quote api during proposal to update pincode
		UPDATE Insurance_LeadDetails SET TotalPremium = @TotalPremium, GrossPremium = @GrossPremiume, Tax = @Tax     
		WHERE LeadId = @LeadId  
	 END
    END          
  END          
       
 IF(ISNULL(@IsBrandNew,'') = '')  
 BEGIN  
  SELECT @IsBrandNew = IsBrandNew FROM Insurance_LeadDetails WITH(NOLOCK) WHERE LeadId = @LeadId   
 END  
    IF(@IsBrandNew=1)    
 BEGIN  
  SELECT INS.Logo,KHD.SelfVideoClaims,KHD.SelfDescription,INS.IsRecommended,INS.RecommendedDescription,KHD.GarageDescription    
  FROM Insurance_Insurer INS WITH(NOLOCK)            
  JOIN Insurance_KeyHighlightsDescription KHD WITH(NOLOCK) ON KHD.InsurerId = INS.InsurerId   
  LEFT JOIN Insurance_LeadDetails IL WITH(NOLOCK) ON IL.LeadId = @LeadId  
  WHERE INS.InsurerId = @InsurerId AND INS.IsActive = 1 AND KHD.PolicyTypeId = '517D8F9C-F532-4D45-8034-ABECE46693E3' AND KHD.VehicleTypeId = IL.VehicleTypeId  
 END  
 ELSE  
 BEGIN  
  SELECT INS.Logo,KHD.SelfVideoClaims,KHD.SelfDescription,INS.IsRecommended,INS.RecommendedDescription,KHD.GarageDescription    
  FROM Insurance_Insurer INS WITH(NOLOCK)            
  JOIN Insurance_KeyHighlightsDescription KHD WITH(NOLOCK) ON KHD.InsurerId = INS.InsurerId   
  LEFT JOIN Insurance_LeadDetails IL WITH(NOLOCK) ON IL.LeadId = @LeadId  
  WHERE INS.InsurerId = @InsurerId AND INS.IsActive = 1 AND KHD.PolicyTypeId = ISNULL(@PolicyTypeId,IL.PolicyTypeId) AND KHD.VehicleTypeId = IL.VehicleTypeId  
 END  
    
  SELECT GarageId,WorkshopName,FullAddress,City,State,Pincode,Latitude,Longitude,ProductType,EmailId,MobileNumber,ContactPerson                
  FROM  Insurance_CashlessGarage WITH(NOLOCK)                 
  WHERE insurerId=@InsurerId                 
                
  SELECT Id AS PremiumBasicDetailsId,Title                 
  FROM Insurance_PremiumBasicDetail WITH(NOLOCK) WHERE insurerId=@InsurerId                 
                
  SELECT PremiumBasicDetailId,Id as SubtitleId,Subtitle, Description, Icon                
  FROM Insurance_PremiumBasicSubtitleDetail WITH(NOLOCK) WHERE insurerId=@InsurerId                 
                
  SELECT @QuoteTranID QuoteTransactionId            
            
 END TRY                
 BEGIN CATCH                           
   DECLARE @StrProcedure_Name varchar(500), @ErrorDetail varchar(1000), @ParameterList varchar(2000)                                            
   SET @StrProcedure_Name=ERROR_PROCEDURE()                                            
   SET @ErrorDetail=ERROR_MESSAGE()                                            
   EXEC dbo.Insurance_InsertErrorDetail @StrProcedure_Name=@StrProcedure_Name,@ErrorDetail=@ErrorDetail,@ParameterList=@ParameterList                                        
 END CATCH                
END 